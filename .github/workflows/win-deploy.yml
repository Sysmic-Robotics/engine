name: Windows Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build and Package (Windows - MinGW/GCC)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt 6 (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw' 
          modules: 'qtserialport qtwebsockets' 

      - name: Configure CMake
        run: |
          # 1. Attempt to find the Qt directory
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir -or $qtDir -eq "") {
            Write-Host "Qt6_DIR is empty, checking QT_ROOT_DIR..."
            $qtDir = $env:QT_ROOT_DIR
          }
          Write-Host "Qt Directory found at: $qtDir"

          # 2. Find the Compiler (G++)
          # Standard Qt structure puts compilers in a 'Tools' folder parallel to the version folder.
          # Structure: C:\Qt\6.7.2\mingw_64  vs  C:\Qt\Tools\mingw1120_64\bin
          
          $gpp = $null
          $gcc = $null

          # Method A: Check explicitly in the Qt bin (sometimes happens, but failed previously)
          if (Test-Path "$qtDir\bin\g++.exe") {
             $gpp = "$qtDir\bin\g++.exe"
             $gcc = "$qtDir\bin\gcc.exe"
          } 
          # Method B: Search in the Tools directory (Standard Layout)
          else {
             # Go up two levels from .../6.7.2/mingw_64 to root, then into Tools
             $toolPathPattern = Join-Path (Split-Path (Split-Path $qtDir -Parent) -Parent) "Tools\mingw*\bin\g++.exe"
             Write-Host "Searching for compiler with pattern: $toolPathPattern"
             
             $found = Get-Item $toolPathPattern -ErrorAction SilentlyContinue | Select-Object -First 1
             if ($found) {
                $gpp = $found.FullName
                $gcc = $found.FullName -replace "g\+\+\.exe", "gcc.exe"
             }
          }

          # 3. Verify validity
          if (-not $gpp -or -not (Test-Path $gpp)) { 
             Write-Host "ERROR: Could not find g++.exe. Listing directories near Qt root for debugging:"
             Get-ChildItem (Split-Path (Split-Path $qtDir -Parent) -Parent) -Recurse -Depth 2 | Select-Object FullName
             throw "Compiler detection failed." 
          }

          Write-Host "Compiler found: $gpp"

          # 4. Force CMake to use these specific compilers
          # Use forward slashes for CMake
          $qtDirCmake = $qtDir -replace '\\', '/'
          $gppCmake = $gpp -replace '\\', '/'
          $gccCmake = $gcc -replace '\\', '/'

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$qtDirCmake" `
            -DCMAKE_C_COMPILER="$gccCmake" `
            -DCMAKE_CXX_COMPILER="$gppCmake"
            
      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Bundle Qt runtime
        run: |
          # Recover Qt dir
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir) { $qtDir = $env:QT_ROOT_DIR }
          
          $exePath = "build/src/engine.exe"
          
          if (-Not (Test-Path $exePath)) {
            $exePath = "build/src/engine/engine.exe" 
            if (-Not (Test-Path $exePath)) {
              throw "Executable not found. Tried build/src/engine.exe and build/src/engine/engine.exe"
            }
          }
          
          & "$qtDir\bin\windeployqt.exe" $exePath --compiler-runtime --no-translations

      - name: Stage deployment bundle
        run: |
          $distDir = "dist/engine-windows"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          $exePath = "build/src/engine.exe"
          if (-Not (Test-Path $exePath)) { $exePath = "build/src/engine/engine.exe" }
          $deployedFilesDir = (Split-Path $exePath)
          
          if (Test-Path "build/config.ini") {
             Copy-Item "build/config.ini" $distDir -ErrorAction Stop
          }

          Copy-Item "$deployedFilesDir/*" $distDir -Recurse -Force
          
          Get-ChildItem -Path $distDir -Include *.pdb, *.lib -Recurse | Remove-Item -Force

      - name: Compress artifact
        run: |
          $zipName = "engine-${{ github.ref_name }}-windows-mingw-x64.zip"
          Compress-Archive -Path dist/engine-windows/* -DestinationPath $zipName
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifact
          path: engine-v*-windows-mingw-x64.zip
          if-no-files-found: error

  release-github:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [build-windows]

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifact

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: engine-v*-windows-mingw-x64.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}