name: Windows Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build and Package (Windows - MinGW/GCC)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt 6 (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw' 
          modules: 'qtserialport qtwebsockets' 

      - name: Configure CMake (Using Explicit MinGW Compilers)
        run: |
          # Define the path to the compilers installed by the Qt action
          $QtBinDir = "${{ env.Qt6_DIR }}\bin"
          $GccPath = "$QtBinDir\gcc.exe"
          $GppPath = "$QtBinDir\g++.exe"
          
          # CRITICAL FIX: Explicitly set the C and C++ compilers to use the Qt-bundled MinGW
          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="${{ env.Qt6_DIR }}" `
            -DCMAKE_C_COMPILER="$GccPath" `
            -DCMAKE_CXX_COMPILER="$GppPath"

      - name: Build
        # We need to make sure we use the mingw32-make installed by Qt, 
        # but the default 'cmake --build' command should find the correct one 
        # since we set the compiler paths above.
        run: cmake --build build --config Release --parallel

      - name: Bundle Qt runtime
        run: |
          # NOTE: MinGW builds often put the executable directly under the build subdirectory
          $exePath = "build/src/engine.exe"
          
          # Fallback check for common MinGW path if the first guess fails
          if (-Not (Test-Path $exePath)) {
            $exePath = "build/src/engine/engine.exe" 
            if (-Not (Test-Path $exePath)) {
              throw "Executable not found. Tried build/src/engine.exe and build/src/engine/engine.exe"
            }
          }
          
          & "${{ env.Qt6_DIR }}\bin\windeployqt.exe" $exePath --compiler-runtime --no-translations

      - name: Stage deployment bundle
        run: |
          $distDir = "dist/engine-windows"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          # Get the directory where the executable and deployed files reside
          $deployedFilesDir = (Split-Path $exePath)
          
          if (Test-Path "build/config.ini") {
             Copy-Item "build/config.ini" $distDir -ErrorAction Stop
          }

          Copy-Item "$deployedFilesDir/*" $distDir -Recurse -Force
          
          Get-ChildItem -Path $distDir -Include *.pdb, *.lib -Recurse | Remove-Item -Force

      - name: Compress artifact
        run: |
          $zipName = "engine-${{ github.ref_name }}-windows-mingw-x64.zip"
          Compress-Archive -Path dist/engine-windows/* -DestinationPath $zipName
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifact
          path: engine-v*-windows-mingw-x64.zip
          if-no-files-found: error

  release-github:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [build-windows]

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifact

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: engine-v*-windows-mingw-x64.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}