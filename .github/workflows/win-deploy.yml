name: Windows Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build and Package (Windows - MinGW/GCC)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt 6 (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw' 
          tools: 'tools_mingw'
          modules: 'qtserialport qtwebsockets' 

      - name: Configure CMake
        run: |
          # 1. Attempt to find the Qt directory
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir -or $qtDir -eq "") {
            $qtDir = $env:QT_ROOT_DIR
          }
          Write-Host "Qt Directory found at: $qtDir"

          # 2. Find the Compiler (G++)
          $gpp = $null
          $gcc = $null
          
          $qtRoot = Split-Path (Split-Path $qtDir -Parent) -Parent
          $toolsDir = Join-Path $qtRoot "Tools"
          Write-Host "Searching for modern MinGW in: $toolsDir"

          # CRITICAL FIX: Search strategy updated to avoid legacy 'Tools\MinGW'.
          # We strictly look for directories matching 'mingw*_64' (e.g., mingw1120_64)
          # and sort descending to pick the newest version if multiple exist.
          $compilerDir = Get-ChildItem -Path $toolsDir -Directory -Filter "mingw*_64" -ErrorAction SilentlyContinue | 
                         Sort-Object Name -Descending | 
                         Select-Object -First 1
          
          if ($compilerDir) {
             $gpp = Join-Path $compilerDir.FullName "bin\g++.exe"
             $gcc = Join-Path $compilerDir.FullName "bin\gcc.exe"
          } else {
             # Fallback: Try to find any mingw folder that ISN'T just "MinGW"
             Write-Host "Standard mingw*_64 folder not found. Attempting broader search..."
             $compiler = Get-ChildItem -Path $toolsDir -Filter "g++.exe" -Recurse -ErrorAction SilentlyContinue | 
                         Where-Object { $_.FullName -notmatch "\\Tools\\MinGW\\" } |
                         Select-Object -First 1
             if ($compiler) {
                $gpp = $compiler.FullName
                $gcc = $compiler.FullName -replace "g\+\+\.exe", "gcc.exe"
             }
          }

          # 3. Verify validity
          if (-not $gpp -or -not (Test-Path $gpp)) { 
             Write-Host "ERROR: Could not find a suitable g++.exe in $toolsDir"
             Write-Host "Listing directories in Tools for debugging:"
             Get-ChildItem $toolsDir | Select-Object Name, FullName | Format-Table
             throw "Compiler detection failed." 
          }

          Write-Host "Compiler found: $gpp"

          # 4. Force CMake to use these specific compilers
          # Use forward slashes for CMake paths to ensure compatibility
          $qtDirCmake = $qtDir -replace '\\', '/'
          $gppCmake = $gpp -replace '\\', '/'
          $gccCmake = $gcc -replace '\\', '/'

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$qtDirCmake" `
            -DCMAKE_C_COMPILER="$gccCmake" `
            -DCMAKE_CXX_COMPILER="$gppCmake"
            
      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Bundle Qt runtime
        run: |
          # Recover Qt dir
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir) { $qtDir = $env:QT_ROOT_DIR }
          
          $exePath = "build/src/engine.exe"
          
          if (-Not (Test-Path $exePath)) {
            $exePath = "build/src/engine/engine.exe" 
            if (-Not (Test-Path $exePath)) {
              throw "Executable not found. Tried build/src/engine.exe and build/src/engine/engine.exe"
            }
          }
          
          & "$qtDir\bin\windeployqt.exe" $exePath --compiler-runtime --no-translations

      - name: Stage deployment bundle
        run: |
          $distDir = "dist/engine-windows"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          $exePath = "build/src/engine.exe"
          if (-Not (Test-Path $exePath)) { $exePath = "build/src/engine/engine.exe" }
          $deployedFilesDir = (Split-Path $exePath)
          
          if (Test-Path "build/config.ini") {
             Copy-Item "build/config.ini" $distDir -ErrorAction Stop
          }

          Copy-Item "$deployedFilesDir/*" $distDir -Recurse -Force
          
          Get-ChildItem -Path $distDir -Include *.pdb, *.lib -Recurse | Remove-Item -Force

      - name: Compress artifact
        run: |
          $zipName = "engine-${{ github.ref_name }}-windows-mingw-x64.zip"
          Compress-Archive -Path dist/engine-windows/* -DestinationPath $zipName
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifact
          path: engine-v*-windows-mingw-x64.zip
          if-no-files-found: error

  release-github:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [build-windows]

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifact

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: engine-v*-windows-mingw-x64.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}