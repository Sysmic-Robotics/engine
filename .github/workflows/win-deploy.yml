name: Windows Deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build and Package (Windows - MinGW/GCC)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt 6 (MinGW)
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.2'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_mingw' 
          modules: 'qtserialport qtwebsockets' 

      - name: Configure CMake
        run: |
          # 1. Attempt to find the Qt directory using standard variables
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir -or $qtDir -eq "") {
            Write-Host "Qt6_DIR is empty, checking QT_ROOT_DIR..."
            $qtDir = $env:QT_ROOT_DIR
          }

          # 2. Debugging: If still empty, print all env vars to help debug
          if (-not $qtDir -or $qtDir -eq "") { 
             Write-Host "ERROR: Could not locate Qt directory. Printing environment variables:"
             Get-ChildItem env: | Out-String | Write-Host
             throw "Qt Directory not found in environment variables."
          }

          Write-Host "Qt Directory found at: $qtDir"

          # 3. Construct absolute paths to the compilers using Windows slashes
          $gpp = "$qtDir\bin\g++.exe"
          $gcc = "$qtDir\bin\gcc.exe"
          
          # 4. Verify compilers exist
          if (-not (Test-Path $gpp)) { 
            # Try looking in the parent directory if bin structure is different
            throw "G++ not found at $gpp" 
          }
          
          # 5. Force CMake to use these specific compilers
          # Note: We use forward slashes for CMake paths to avoid escape issues
          $qtDirCmake = $qtDir -replace '\\', '/'
          $gppCmake = $gpp -replace '\\', '/'
          $gccCmake = $gcc -replace '\\', '/'

          cmake -S . -B build -G "MinGW Makefiles" `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_PREFIX_PATH="$qtDirCmake" `
            -DCMAKE_C_COMPILER="$gccCmake" `
            -DCMAKE_CXX_COMPILER="$gppCmake"
            
      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Bundle Qt runtime
        run: |
          # Recover the Qt dir again for this step (vars don't persist between steps unless using env file)
          $qtDir = $env:Qt6_DIR
          if (-not $qtDir) { $qtDir = $env:QT_ROOT_DIR }
          
          $exePath = "build/src/engine.exe"
          
          if (-Not (Test-Path $exePath)) {
            $exePath = "build/src/engine/engine.exe" 
            if (-Not (Test-Path $exePath)) {
              throw "Executable not found. Tried build/src/engine.exe and build/src/engine/engine.exe"
            }
          }
          
          & "$qtDir\bin\windeployqt.exe" $exePath --compiler-runtime --no-translations

      - name: Stage deployment bundle
        run: |
          $distDir = "dist/engine-windows"
          New-Item -ItemType Directory -Force -Path $distDir | Out-Null
          
          $exePath = "build/src/engine.exe"
          if (-Not (Test-Path $exePath)) { $exePath = "build/src/engine/engine.exe" }
          $deployedFilesDir = (Split-Path $exePath)
          
          if (Test-Path "build/config.ini") {
             Copy-Item "build/config.ini" $distDir -ErrorAction Stop
          }

          Copy-Item "$deployedFilesDir/*" $distDir -Recurse -Force
          
          Get-ChildItem -Path $distDir -Include *.pdb, *.lib -Recurse | Remove-Item -Force

      - name: Compress artifact
        run: |
          $zipName = "engine-${{ github.ref_name }}-windows-mingw-x64.zip"
          Compress-Archive -Path dist/engine-windows/* -DestinationPath $zipName
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-release-artifact
          path: engine-v*-windows-mingw-x64.zip
          if-no-files-found: error

  release-github:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    needs: [build-windows]

    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-release-artifact

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          files: engine-v*-windows-mingw-x64.zip
          draft: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}